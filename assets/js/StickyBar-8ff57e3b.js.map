{"version":3,"file":"StickyBar-8ff57e3b.js","sources":["../../../../src/stores/ui/sticky.js","../../../../src/components/ui/common/StickyBar.vue"],"sourcesContent":["import { defineStore } from 'pinia';\n\nexport const useUiStickyStore = defineStore('uiSticky', {\n  state: () => ({\n    items: [],\n    count: 1,\n  }),\n  actions: {\n    add(height = 0) {\n      const key = this.count;\n\n      this.items.push({\n        key,\n        height,\n      });\n\n      this.count++;\n\n      return key;\n    },\n    remove(key) {\n      const i = this.items.findIndex((item) => item.key === key);\n\n      this.items.splice(i, 1);\n    },\n    update(key, height = 0) {\n      const i = this.items.findIndex((item) => item.key === key);\n\n      if (this.items[i].height !== height) {\n        this.items[i].height = height;\n      }\n    },\n  },\n});\n","<script>\nimport {\n  ref,\n  reactive,\n  computed,\n  onBeforeMount,\n  onMounted,\n  onBeforeUnmount,\n  nextTick,\n  inject,\n  provide,\n} from 'vue';\n\nimport { useUiScrollBlockStore } from '@/stores/ui/scrollBlock';\nimport { useUiHeaderStore } from '@/stores/ui/header';\nimport { useUiStickyStore } from '@/stores/ui/sticky';\n\nconst defaultClassNames = () => ({\n  wrap: '',\n  contents: '',\n  fake: '',\n});\n\nexport default {\n  props: {\n    classNames: {\n      Type: Object,\n      default() {\n        return defaultClassNames();\n      },\n    },\n  },\n  setup(props) {\n    const uiLayer = inject('uiLayer', {});\n    const popupLayout = inject('popupLayout', {});\n\n    const store = {\n      ui: {\n        scrollBlock: useUiScrollBlockStore(),\n        header: useUiHeaderStore(),\n        sticky: useUiStickyStore(),\n      },\n    };\n\n    const state = reactive({\n      isSticky: false,\n      marginTop: '0',\n      marginBottom: '0',\n      height: '0',\n      storeKey: null,\n    });\n\n    const wrap = ref(null);\n    const contents = ref(null);\n    const fake = ref(null);\n\n    const customClassNames = computed(() => {\n      const { classNames } = props;\n      return Object.assign(defaultClassNames(), classNames);\n    });\n\n    const headerH = computed(() => {\n      const popupHead =\n        popupLayout && popupLayout.head && popupLayout.head.value;\n      const popupHeadH = (() => {\n        if (popupHead) {\n          return popupHead.offsetHeight;\n        } else {\n          return 0;\n        }\n      })();\n\n      return popupHeadH || store.ui.header.height;\n    });\n\n    const stickyH = computed(() => {\n      return getStickyH();\n    });\n\n    const getStickyH = () => {\n      const { items } = store.ui.sticky;\n      let height = 0;\n\n      if (state.storeKey) {\n        for (let i = 0; i < items.length; i++) {\n          if (items[i].key === state.storeKey) break;\n\n          height += items[i].height;\n        }\n      }\n\n      return height;\n    };\n\n    const setMargin = () => {\n      const contentsEl = contents.value;\n      const contentsInnerEl = contentsEl.children[0];\n      const contentsInnerStyles = getComputedStyle(contentsInnerEl);\n      const marginTop = contentsInnerStyles.getPropertyValue('margin-top');\n      const marginBottom =\n        contentsInnerStyles.getPropertyValue('margin-bottom');\n\n      state.marginTop = marginTop;\n      state.marginBottom = marginBottom;\n    };\n\n    const update = () => {\n      const wrapEl = wrap.value;\n\n      if (wrapEl.offsetHeight <= 0) return;\n\n      const html = document.getElementsByTagName('html')[0];\n      const contentsEl = contents.value;\n      const contentsInnerEl = contentsEl.children[0];\n      const popupBody =\n        popupLayout && popupLayout.body && popupLayout.body.value;\n      const headH = headerH.value;\n      const htmlScrollTop = html.scrollTop;\n      const scrollTop = (() => {\n        if (popupBody) {\n          return popupBody.scrollTop + headH;\n        } else if (store.ui.scrollBlock.isBlocking) {\n          return store.ui.scrollBlock.scrollTop;\n        } else {\n          return htmlScrollTop;\n        }\n      })();\n      const offsetTop =\n        (popupBody ? scrollTop + htmlScrollTop : scrollTop) +\n        wrapEl.getBoundingClientRect().top;\n      const stickyH = getStickyH();\n      const height = contentsInnerEl.offsetHeight;\n\n      if (popupBody) {\n        if (state.storeKey) {\n          store.ui.sticky.remove(state.storeKey);\n          state.storeKey = null;\n        }\n      } else if (state.storeKey) {\n        store.ui.sticky.update(state.storeKey, height);\n      } else {\n        state.storeKey = store.ui.sticky.add(height);\n      }\n\n      if (scrollTop <= offsetTop - headH - stickyH) {\n        if (state.isSticky) {\n          state.isSticky = false;\n        }\n        return;\n      }\n\n      state.height = `${height}px`;\n\n      if (!state.isSticky) {\n        state.isSticky = true;\n      }\n    };\n\n    const scroll = () => {\n      update();\n    };\n\n    const resize = () => {\n      update();\n    };\n\n    const load = () => {\n      update();\n    };\n\n    const scrollBind = () => {\n      const popupBody =\n        popupLayout && popupLayout.body && popupLayout.body.value;\n\n      if (popupBody) {\n        popupBody.addEventListener('scroll', scroll);\n      }\n    };\n\n    const getElement = () => {\n      return wrap.value;\n    };\n\n    onBeforeMount(() => {\n      if (uiLayer && uiLayer.stickyBar) {\n        uiLayer.stickyBar.value = {\n          update,\n        };\n        popupLayout.stickyBar.value = {\n          scrollBind,\n        };\n      }\n    });\n\n    onMounted(() => {\n      setMargin();\n\n      nextTick(() => {\n        update();\n      });\n\n      window.addEventListener('load', load);\n      window.addEventListener('scroll', scroll);\n      window.addEventListener('resize', resize);\n    });\n\n    onBeforeUnmount(() => {\n      if (state.storeKey) {\n        store.ui.sticky.remove(state.storeKey);\n      }\n\n      window.removeEventListener('load', load);\n      window.removeEventListener('scroll', scroll);\n      window.removeEventListener('resize', resize);\n\n      const popupBody =\n        popupLayout && popupLayout.body && popupLayout.body.value;\n\n      if (popupBody) {\n        popupBody.removeEventListener('scroll', scroll);\n      }\n    });\n\n    provide('stickyBar', {\n      getElement,\n    });\n\n    return {\n      state,\n      wrap,\n      contents,\n      fake,\n      customClassNames,\n      headerH,\n      stickyH,\n    };\n  },\n};\n</script>\n\n<template>\n  <div ref=\"wrap\" :class=\"customClassNames.wrap\">\n    <div\n      ref=\"contents\"\n      :style=\"{\n        position: state.isSticky ? 'fixed' : 'static',\n        top: state.isSticky ? `${headerH + stickyH}px` : null,\n        left: state.isSticky ? '0' : null,\n        width: state.isSticky ? '100%' : null,\n        zIndex: state.isSticky ? '1000' : null,\n        transform: 'translateZ(0)',\n        transition: 'transform 0s',\n      }\"\n      :class=\"[\n        {\n          'is-sticky': state.isSticky,\n        },\n        customClassNames.contents,\n      ]\"\n    >\n      <slot :isSticky=\"state.isSticky\" />\n    </div>\n    <div\n      :class=\"customClassNames.fake\"\n      :style=\"{\n        display: state.isSticky ? 'block' : 'none',\n        marginTop: state.marginTop,\n        marginBottom: state.marginBottom,\n        height: state.height,\n      }\"\n    ></div>\n  </div>\n</template>\n"],"names":["useUiStickyStore","defineStore","height","key","i","item","defaultClassNames","_sfc_main","props","uiLayer","inject","popupLayout","store","useUiScrollBlockStore","useUiHeaderStore","state","reactive","wrap","ref","contents","fake","customClassNames","computed","classNames","headerH","popupHead","stickyH","getStickyH","items","setMargin","contentsInnerEl","contentsInnerStyles","marginTop","marginBottom","update","wrapEl","html","popupBody","headH","htmlScrollTop","scrollTop","offsetTop","scroll","resize","load","scrollBind","getElement","onBeforeMount","onMounted","nextTick","onBeforeUnmount","provide","_createElementBlock","_normalizeClass","$setup","_createElementVNode","_normalizeStyle","_renderSlot","_ctx"],"mappings":"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"}